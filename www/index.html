<html>
    <head>
        <link rel="stylesheet" href="css/main.css">
        <script src="js/streamWSclient.js"></script>
        <script src="js/jpeg-extractor.js"></script>
    </head>
    <body>
        <video id='vid'  width="1280" height="720" style='width:100vw;height:56.25vw;display:none;border:solid red 1px;' controls></video>
        <canvas id='cid' width="1280" height="720" style='width:100vw;height:56.25vw;display:none;border:solid green 1px;'></canvas>

        <div id='console-log-div'></div>

        <script src="js/console-log-div.js"></script>

        <script>

            /* initialise media element */
            var video = document.getElementById('vid');
            var canvas = document.getElementById('cid');
            var ctxt = canvas.getContext("2d");
            var mediaSource = null;
            var sourceBuffer = null;
            var queue=[];
            var mimeCodec = 'video/x-msvideo';//'video/webm; codecs="vp8,vorbis"';//'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';//'video/mp4; codecs="avc1.42c01e"'

            mjpegDecoder = new JPEGExtractorStream();

            /* special websocket stream */
            var myStream = new WSStream('ws://' + location.hostname + ':8343');



            if ('MediaSource' in window && MediaSource.isTypeSupported(mimeCodec)) {
                mediaSource = new MediaSource();
                video.src = window.URL.createObjectURL(mediaSource);
                video.style.display = 'block';
                /* bind mediaSource buffer to websocket stream data */
                mediaSource.addEventListener('sourceopen', function(){

                        sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);

                        sourceBuffer.addEventListener('updateend', function() {
                            if ( queue.length ) {
                                sourceBuffer.appendBuffer(queue.shift());
                            }
                        }, false);

                        sourceBuffer.addEventListener('remove', function() {
                            console.error("source buffer remove");
                        }, false);

                        myStream.ondata = function(_d) {
                             //var d=new Uint8Array(_d);
                             var d=_d;
                             if (!sourceBuffer.updating && sourceBuffer.buffered.length > 0) {
                                console.debug("buffer not updating");
                                sourceBuffer.appendBuffer(d);// new Uint8Array(d);
                             } else {
                                if(!sourceBuffer.updating) sourceBuffer.appendBuffer(d);
                                else queue.push(d);
                             }
                            if (video.paused) {
                                video.play();
                            }
                        }
                        myStream.init();
                });


            } else {


                console.error('Video MediaElement does not support: '+mimeCodec+' -> trying with MotionJPEG');
                canvas.style.display = 'block';


                mjpegDecoder.on('image', function (imgData) {

                    var img = null;
                    try {
                        img = new Image;
                    } catch(e) {
                        //console.log
                    }
                    var w,h;
                    var uInt8Array = imgData;
                    var i = uInt8Array.length;
                    var binaryString = [i];
                    while (i--) {
                      binaryString[i] = String.fromCharCode(uInt8Array[i]);
                    }
                    var data = binaryString.join('');
                    var base64 = window.btoa(data);
                    img.src = "data:image/jpeg;base64," + base64;
                    img.onload = function () {
                         w=img.width; h=img.height;
                         ctxt.drawImage(img,0,0,w,h,0,0,ctxt.canvas.width,ctxt.canvas.height);
                    };
                    img.onerror = function (stuff) {
                    };
                });

                myStream.ondata = function(_d) {
                    mjpegDecoder.write(_d);
                }
                myStream.init();
            }






        </script>

    </body>
</html>
